function e(){return i()&&s()}function t(){return i()&&n()}function s(){return"undefined"!=typeof hmApp}function n(){return"undefined"!=typeof __$$R$$__}function i(){return s()||n()}let r=null;r="undefined"!=typeof __$$R$$__?__$$R$$__:()=>({});let a=null;e()?a=DeviceRuntimeCore.HmLogger:t()?a=r("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(a=Logger);const o=r("@zos/utils").EventBus,h=r("@zos/timer").setTimeout,d=r("@zos/timer").clearTimeout,p=globalThis.Promise;function c(){const e={canceled:!1};return e.promise=new p((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}let u=null;e()?u=hmBle:t()&&(u=r("@zos/ble"));let l=Buffer;function y(e){return g(function(e){return JSON.stringify(e)}(e))}function f(e){return t=I(e),JSON.parse(t);var t}function g(e){return l.from(e,"utf-8")}function I(e){return e.toString("utf-8")}function m(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function T(e){return t=function(e){return l.from(e)}(e),t.toString("hex");var t}function k(e){return"object"==typeof e&&!l.isBuffer(e)&&!Array.isArray(e)&&null!==e}const b=i()?a.getLogger("device-message"):a.getLogger("side-message"),L=void 0,w="json",S="text",q="bin";function C(e){switch(e.toLowerCase()){case w:return 2;case S:return 1;case q:return 3;case"empty":return 0;default:return 3}}let B=1e4;function U(){return B++}let v=1e3;function E(){return v++}class P extends o{constructor(e,t,s,n){super(),this.id=e,this.type=t,this.ctx=n,this.chunks=[],this.count=-1,this.finishChunk=null,this.size=s,this.receivedSize=0}addChunk(e){this.receivedSize+=e.payloadLength,1===e.opCode&&(this.count=e.seqId+1,this.finishChunk=e),e.payloadLength===e.payload.byteLength?(this.chunks.push(e),this.checkIfReceiveAllChunks()):this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`))}checkIfReceiveAllChunks(){if(this.count!==this.chunks.length)return;if(!this.finishChunk)return;if(this.size!==this.receivedSize)return;this.chunks.sort(((e,t)=>e.seqId-t.seqId));let e=[];for(let t=0;t<this.count;t++){const s=this.chunks[t];if(!s||s.seqId!==t)return e=null,this.releaseBuf(),void this.emit("error",Error("receive data error"));e.push(s.payload)}this.chunks=[],this.finishChunk.payload=l.concat(e),e=null,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`))}releaseBuf(){this.chunks=[],this.finishChunk=null,this.count=0,this.size=0,this.receivedSize=0}}class D{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s,n){const i=new P(e,t,s,n);return this.sessions.set(this.key(i),i),i}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class z extends Error{constructor(e,t){super(t),this.code=e,this.reason=t}}class $ extends o{constructor({appId:e=0,appDevicePort:t=20,appSidePort:s=0,ble:n=(i()?u:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:i()?u:void 0}){super(),this.isDevice=i(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=s,this.ble=n,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new D,this.on("response",(e=>{this.onResponse(e)})),n?.addListener((e=>{this.emit("bleStatusChanged",e)})),this.on("bleStatusChanged",(e=>{if(!e){b.error("ble disconnect"),this.shakeTask&&(this.shakeTask.reject(new z(2,"ble disconnect")),this.shakeStatus=4);for(const[e,t]of Object.entries(this.handlers))t.task.reject(new z(2,"ble disconnect"));this.handlers.clear()}}))}fork(e=5e3){if(2===this.shakeStatus)return this.waitingShakePromise;this.shakeTask=c(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=h((()=>{this.shakeStatus=4,this.shakeTask.reject(new z(1,"shake timeout"))}),e);try{this.errorIfBleDisconnect()}catch(e){return b.error("error ble disconnect %j",e),this.shakeTask.reject(new z(2,"ble disconnect")),this.shakeStatus=4,this.waitingShakePromise}return this.shakeStatus=2,this.sendShake(),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&d(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return f(e)}json2Buf(e){return y(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=p.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let s=l.alloc(t),n=0;return s.writeUInt8(e.flag,n),n+=1,s.writeUInt8(e.version,n),n+=1,s.writeUInt16LE(e.type,n),n+=2,s.writeUInt16LE(e.port1,n),n+=2,s.writeUInt16LE(e.port2,n),n+=2,s.writeUInt32LE(e.appId,n),n+=4,s.writeUInt32LE(e.extra,n),n+=4,s.fill(e.payload,n,e.payload.byteLength+n),s}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:l.from([this.appId])})}sendShake(){b.info("shake send");const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:l.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=l.from(e);let s=0;const n=t.readUInt8(s);s+=1;const i=t.readUInt8(s);s+=1;const r=t.readUInt16LE(s);s+=2;const a=t.readUInt16LE(s);s+=2;const o=t.readUInt16LE(s);s+=2;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt32LE(s);return s+=4,{flag:n,version:i,type:r,port1:a,port2:o,appId:h,extra:d,payload:t.subarray(s)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=L){if(t&&b.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,T(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=L){t&&b.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,T(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:s,contentType:n,dataType:i},{messageType:r=4}={}){const a=3518,o=t.byteLength;let h=0;const d=l.alloc(a),p=e||U(),c=E();let u=0;const y=Math.ceil(o/a);function f(){return u++}for(let e=1;e<=y;e++){if(this.errorIfBleDisconnect(),e===y){const e=o-h,a=l.alloc(0+e);t.copy(a,0,h,h+e),h+=e,this.sendDataWithSession({traceId:p,spanId:c,seqId:f(),payload:a,type:s,opCode:1,totalLength:o,contentType:n,dataType:i},{messageType:r});break}t.copy(d,0,h,h+a),h+=a,this.sendDataWithSession({traceId:p,spanId:c,seqId:f(),payload:d,type:s,opCode:0,totalLength:o,contentType:n,dataType:i},{messageType:r})}}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=y(t),a=e||U();this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||U();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const r=g(t),a=e||U();return this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:a,contentType:o,dataType:h},{messageType:d}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:i,opCode:r,payload:n,contentType:o,dataType:h});let c=this.isDevice?this.buildData(p,{type:d}):p;this.sendMsg(c)}buildPayload(e){const t=66+e.payload.byteLength;let s=l.alloc(t),n=0;return s.writeUInt32LE(e.traceId,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(e.spanId,n),n+=4,s.writeUInt32LE(e.seqId,n),n+=4,s.writeUInt32LE(e.totalLength,n),n+=4,s.writeUInt32LE(e.payload.byteLength,n),n+=4,s.writeUInt8(e.type,n),n+=1,s.writeUInt8(e.opCode,n),n+=1,s.writeUInt32LE(this.now(),n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt8(e.contentType,n),n+=1,s.writeUInt8(e.dataType,n),n+=1,s.writeUInt16LE(0,n),n+=2,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.fill(e.payload,n,e.payload.byteLength+n),s}readPayload(e){const t=l.from(e);let s=0;const n=t.readUInt32LE(s);s+=4;const i=t.readUInt32LE(s);s+=4;const r=t.readUInt32LE(s);s+=4;const a=t.readUInt32LE(s);s+=4;const o=t.readUInt32LE(s);s+=4;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt8(s);s+=1;const p=t.readUInt8(s);s+=1;const c=t.readUInt32LE(s);s+=4;const u=t.readUInt32LE(s);s+=4;const y=t.readUInt32LE(s);s+=4;const f=t.readUInt32LE(s);s+=4;const g=t.readUInt32LE(s);s+=4;const I=t.readUInt32LE(s);s+=4;const m=t.readUInt32LE(s);s+=4;const T=t.readUInt8(s);s+=1;const k=t.readUInt8(s);s+=1;const b=t.readUInt16LE(s);s+=2;const L=t.readUInt32LE(s);s+=4;const w=t.readUInt32LE(s);return s+=4,{traceId:n,parentId:i,spanId:r,seqId:a,totalLength:o,payloadLength:h,payloadType:d,opCode:p,contentType:T,dataType:k,timestamp1:c,timestamp2:u,timestamp3:y,timestamp4:f,timestamp5:g,timestamp6:I,timestamp7:m,extra1:b,extra2:L,extra3:w,payload:t.subarray(s)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,b.info("shake success appSidePort=>",t.port2),this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(i()&&!this.ble.connectStatus())throw new z(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(i()&&!this.appSidePort)throw new z(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId).handler;t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,t.totalLength,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?C(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return b.error("error ble disconnect %j",e),p.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let s=q;"string"==typeof e?s=S:k(e)?s=w:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||l.isBuffer(e))&&(s=q);const n={timeout:6e4,contentType:s,dataType:s},i=U(),r=c();t=Object.assign(n,t);let a=h((()=>{a=null,r.reject(new z(4,`request id=${i} timeout in ${t.timeout}ms`))}),t.timeout);return this.handlers.set(i,{handler:({traceId:e,payload:t,dataType:s})=>{let n;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),s){case 1:n=I(t);break;case 3:default:n=t;break;case 2:n=f(t)}b.info("response id=>%d",i),r.resolve(n)},task:r}),b.info("request id=%d",i),l.isBuffer(e)?this.sendBuf({requestId:i,buf:e,type:1,contentType:3,dataType:C(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:i,buf:l.from(e),type:1,contentType:3,dataType:C(t.dataType)}):2===C(t.contentType)?this.sendJson({requestId:i,json:e,type:1,contentType:2,dataType:C(t.dataType)}):1===C(t.contentType)?this.sendText({requestId:i,text:e,type:1,contentType:1,dataType:C(t.dataType)}):this.sendBuf({requestId:i,buf:l.from(e),type:1,contentType:3,dataType:C(t.dataType)}),r.promise.catch((e=>{throw b.error("request id=%d %d %j",i,e.code,e.reason),e})).finally((()=>{a&&(d(a),a=null),this.handlers.get(i)?this.handlers.delete(i):b.warn("release request id=>%d error",i)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){3===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):1===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):2===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:3})}call(e){let t=2;return"string"==typeof e?t=1:k(e)?t=2:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||l.isBuffer(e))&&(t=3),this.waitingShakePromise.then((()=>l.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:l.from(e),type:3,contentType:3,dataType:0}):2===t?this.sendJson({json:e,type:3,contentType:2,dataType:0}):1===t?this.sendText({text:e,type:3,contentType:1,dataType:0}):this.sendBuf({buf:l.from(e),type:3,contentType:3,dataType:0})))}}class x{constructor(){this.set=new Set}add(e){this.set.add(e)}runAll(...e){this.set.forEach((t=>{t&&t(...e)}))}remove(e){e?this.set.delete(e):this.set.clear()}}a.getLogger("message-builder");const M="hmrpcv1",j=new x,R=new x,A=new x;let _=null;e()?_=hmApp.getPackageInfo:t()&&(_=r("@zos/app").getPackageInfo),e()?hmUI:t()&&r("@zos/ui"),e()?hmSetting:t()&&r("@zos/settings"),e()?px:r("@zos/utils").px,e()?hmSetting.getDeviceInfo:t()&&r("@zos/device").getDeviceInfo,e()?"undefined"!=typeof __$$app$$__&&__$$app$$__:t()&&r("@zos/i18n").getText,e()?hmApp.gotoPage:t()&&r("@zos/router").push;let O=null;function H(e,t={}){return this.request({method:"http.request",params:e},t)}function J(){let e="";for(let t=0;t<12;t++)e+=0===t?Math.floor(9*Math.random())+1:Math.floor(10*Math.random());return e}function W(e){const t={shakeTimeout:5e3,requestTimeout:6e4,transport:s=new $({appId:_().appId,appDevicePort:20,appSidePort:0}),onCall(e){return e?(j.add(e),this):this},offOnCall(e){return j.remove(e),this},call(e){return i()&&s.fork(this.shakeTimeout),e=k(e)?e.contentType?e:{jsonrpc:M,...e}:e,s.call(e)},onRequest(e){return e?(R.add(e),this):this},initOnCall(){s.on("call",(({contentType:e,payload:t})=>{switch(e){case 2:t=f(t);break;case 1:t=I(t);break;default:t=m(t)}j.runAll(t)}))},initOnRequest(){s.on("request",(e=>{let t=e.request.payload;switch(e.request.contentType){case 2:t=f(t);break;case 1:t=I(t);break;default:t=m(t)}R.runAll(t,((s,n,i={})=>2===e.request.contentType&&t?.jsonrpc===M?s?e.response({data:{jsonrpc:M,error:s}}):e.response({data:{jsonrpc:M,result:n}}):e.response({data:n,...i})))}))},cancelAllRequest(){return s.off("response"),this},offOnRequest(e){return R.remove(e),this},request(e,t={}){return i()&&s.fork(this.shakeTimeout),e=k(e)?t.contentType?e:{jsonrpc:M,...e}:e,s.request(e,{timeout:this.requestTimeout,...t}).then((e=>{if(!k(e)||e.jsonrpc!==M)return e;const{error:t,result:s}=e;if(t)throw t;return s}))},connect(){s.connect((()=>{this.initOnCall(),this.initOnRequest(),this.initOnBleChanged()}))},initOnBleChanged(){return s.on("bleStatusChanged",(e=>{A.runAll(e)})),this},onBleChanged(e){return e?(A.add(e),this):this},offOnBleChanged(e){return A.remove(e),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),this.offOnBleChanged(),s.disConnect((()=>{})),this},start(){return s.listen((()=>{this.initOnCall(),this.initOnRequest()})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),s.disConnect((()=>{})),this}};var s;return{onCreate(){this.messaging=this.globalData.messaging=t,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this._onBleChanged=this.onBleChanged?.bind(this),this.messaging.onCall(this._onCall).onRequest(this._onRequest).onBleChanged(this._onBleChanged).connect()},onDestroy(){this.messaging.offOnCall().offOnRequest().offOnBleChanged().disConnect()},request(e,t={}){const s=c(),n=J(),i="response:result:"+n,r="response:error:"+n;return O.onMessage(i,(function(e,...t){s.resolve(...t)})),O.onMessage(r,(function(e,...t){s.reject(...t)})),this.messaging.request(e,t).then((e=>{O.postMessage(i,e)})).catch((e=>{O.postMessage(r,e)})).finally((()=>{O.offMessage(i),O.offMessage(r)})),s.promise},call(e){return this.messaging.call(e)},httpRequest:H}}e()?O=hmApp:t()&&(O=r("@zos/app"));const V="3.0";export{V as API_LEVEL,W as appPlugin,J as generateRandom12};
